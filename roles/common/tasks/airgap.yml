---
# Setup airgap installation artifacts

- name: Verify airgap directory is specified
  ansible.builtin.assert:
    that:
      - common_k3s_airgap_dir != ""
    fail_msg: "k3s_airgap_dir must be specified for airgap installation"

- name: Create airgap images directory
  ansible.builtin.file:
    path: "{{ common_k3s_data_dir }}/agent/images"
    state: directory
    mode: "0755"

- name: Copy K3s binary from airgap directory
  ansible.builtin.copy:
    src: "{{ common_k3s_airgap_dir }}/k3s"
    dest: /usr/local/bin/k3s
    mode: "0755"

- name: Find airgap image archives
  ansible.builtin.find:
    paths: "{{ common_k3s_airgap_dir }}"
    patterns:
      - "k3s-airgap-images-*.tar"
      - "k3s-airgap-images-*.tar.gz"
      - "k3s-airgap-images-*.tar.zst"
  delegate_to: localhost
  register: common_airgap_images
  become: false

- name: Copy airgap images
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ common_k3s_data_dir }}/agent/images/"
    mode: "0644"
  loop: "{{ common_airgap_images.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Copy K3s install script for airgap
  ansible.builtin.copy:
    src: "{{ common_k3s_airgap_dir }}/install.sh"
    dest: /tmp/k3s-install.sh
    mode: "0755"
  when: common_k3s_install_method == "script"
