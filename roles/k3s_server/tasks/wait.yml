---
# Wait for K3s server to be ready

- name: Wait for K3s API to be available
  ansible.builtin.wait_for:
    host: "{{ k3s_server_bind_address if k3s_server_bind_address != '0.0.0.0' else '127.0.0.1' }}"
    port: "{{ k3s_server_https_listen_port }}"
    timeout: 300

- name: Wait for node-token file
  ansible.builtin.wait_for:
    path: "{{ k3s_server_data_dir }}/server/node-token"
    timeout: 300
  when: k3s_server_init | bool

- name: Wait for kubeconfig
  ansible.builtin.wait_for:
    path: "{{ k3s_server_kubeconfig }}"
    timeout: 300

- name: Wait for node to be ready
  ansible.builtin.command: >
    /usr/local/bin/kubectl --kubeconfig {{ k3s_server_kubeconfig }}
    wait --for=condition=Ready node/{{ k3s_server_node_name }} --timeout=300s
  register: k3s_server_node_ready
  changed_when: false
  retries: 30
  delay: 10
  until: k3s_server_node_ready.rc == 0

- name: Get cluster token for other nodes
  ansible.builtin.slurp:
    src: "{{ k3s_server_data_dir }}/server/node-token"
  register: k3s_server_node_token
  when: k3s_server_init | bool
  no_log: true

- name: Set cluster token fact
  ansible.builtin.set_fact:
    k3s_server_node_token: "{{ k3s_server_node_token.content | b64decode | trim }}"
  when: k3s_server_init | bool
  no_log: true
